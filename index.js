import express from "express";
import { messagingApi, middleware } from "@line/bot-sdk";
import OpenAI from "openai";
import dotenv from "dotenv";

dotenv.config();

const { MessagingApiClient } = messagingApi;

const app = express();

// ======================
//  LINE CONFIG
// ======================
const lineConfig = {
  channelAccessToken: process.env.LINE_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};

// LINE Client v10
const client = new MessagingApiClient(lineConfig);

// ======================
//  OPENAI CONFIG
// ======================
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ======================
//  HUMAN-LIKE DELAY
// ======================
function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// random delay 0.5â€“1.0 sec
async function humanDelay() {
  const delay = 500 + Math.random() * 500; 
  await wait(delay);
}

// ======================
//  AI SYSTEM PROMPT
// ======================
const aiPrompt = `à¸„à¸¸à¸“à¸„à¸·à¸­à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢à¹à¸¥à¸°à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸šà¸£à¸´à¸à¸²à¸£à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸‡à¸£à¹‰à¸²à¸™ â€œbuythrrmâ€ à¸ªà¸´à¸™à¸„à¹‰à¸²: - à¹à¸Ÿà¸¥à¸Šà¹„à¸”à¸£à¹Œà¸Ÿà¸¥à¸‡à¹€à¸žà¸¥à¸‡à¸˜à¸£à¸£à¸¡à¸° MP3 - à¸§à¸´à¸—à¸¢à¸¸à¸˜à¸£à¸£à¸¡à¸°à¹ƒà¸ªà¹ˆ SD Card 32GB - à¸„à¸¸à¸“à¸ à¸²à¸žà¹„à¸Ÿà¸¥à¹Œ 320kbps - à¸£à¸­à¸‡à¸£à¸±à¸š FAT32, à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸ªà¸µà¸¢à¸‡à¸£à¸–à¸¢à¸™à¸•à¹Œà¸—à¸¸à¸à¸›à¸£à¸°à¹€à¸ à¸—, Smart TV, à¸¥à¸³à¹‚à¸žà¸‡à¸šà¸¥à¸¹à¸—à¸¹à¸˜, à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸ªà¸µà¸¢à¸‡à¸šà¹‰à¸²à¸™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ðŸŸ¦ à¹‚à¸—à¸™à¸à¸²à¸£à¸•à¸­à¸š - à¹€à¸£à¸µà¸¢à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² â€œà¸žà¸µà¹ˆâ€ - à¸ªà¸¸à¸ à¸²à¸ž à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ à¹ƒà¸«à¹‰à¹€à¸à¸µà¸¢à¸£à¸•à¸´ - à¸à¸£à¸°à¸Šà¸±à¸š à¸•à¸£à¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™ - à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸£à¹‰à¸²à¸™ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸²: â€œà¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸•à¸­à¸šà¹€à¸‰à¸žà¸²à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¹‰à¸²à¸™ buythrrm à¸™à¸°à¸„à¹ˆà¸°à¸žà¸µà¹ˆâ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ðŸŸ¦ à¸™à¹‚à¸¢à¸šà¸²à¸¢à¹€à¸„à¸¥à¸¡à¸‚à¸­à¸‡à¸£à¹‰à¸²à¸™ - à¹€à¸„à¸¥à¸¡à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸„à¸§à¸²à¸¡à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸‚à¸­à¸‡à¸£à¹‰à¸²à¸™ à¹€à¸Šà¹ˆà¸™ à¹€à¸›à¸´à¸”à¹„à¸¡à¹ˆà¸•à¸´à¸” / à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸¡à¸µ / à¹„à¸Ÿà¸¥à¹Œà¹€à¸›à¸´à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰ - à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²à¹€à¸„à¸¥à¸¡: 7 à¸§à¸±à¸™à¸«à¸¥à¸±à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸² - à¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰: à¸£à¸¹à¸›à¸«à¸£à¸·à¸­à¸§à¸´à¸”à¸µà¹‚à¸­à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸à¸à¸²à¸™ - à¸§à¸´à¸˜à¸µà¸„à¸·à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²: â€œà¹€à¸”à¸µà¹‹à¸¢à¸§à¸œà¸¡à¹€à¸£à¸µà¸¢à¸à¸£à¸– Kerry à¹„à¸›à¸£à¸±à¸šà¸‚à¸­à¸‡à¸–à¸¶à¸‡à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™à¸žà¸µà¹ˆà¹€à¸¥à¸¢à¸„à¸£à¸±à¸šâ€ - à¸¥à¸´à¸‡à¸à¹Œà¹à¸ˆà¹‰à¸‡à¸„à¸·à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²: https://forms.gle/CCpErRw3L1evSYBfA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ðŸŸ¦ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸Šà¹ˆà¸§à¸¢à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸¡à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰ (Troubleshooting) [Step 1] à¹à¸™à¸°à¸™à¸³à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ (à¸«à¹‰à¸²à¸¡à¸£à¸±à¸šà¸„à¸·à¸™à¸—à¸±à¸™à¸—à¸µ) - â€œà¸£à¸šà¸à¸§à¸™à¸žà¸µà¹ˆà¸¥à¸­à¸‡à¸–à¸­à¸”à¹à¸¥à¹‰à¸§à¹€à¸ªà¸µà¸¢à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸«à¹‰à¸ªà¸¸à¸”à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸£à¸·à¸­à¸¥à¸­à¸‡à¸ªà¸¥à¸±à¸šà¸Šà¹ˆà¸­à¸‡ USB à¸”à¸¹à¸™à¸°à¸„à¸£à¸±à¸šâ€ - â€œà¸žà¸µà¹ˆà¸¢à¸±à¸‡à¸à¸”à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹‚à¸«à¸¡à¸” Source à¹€à¸›à¹‡à¸™ USB à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡à¸„à¸£à¸±à¸šâ€ - â€œà¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸Šà¸±à¸§à¸£à¹Œ à¸žà¸µà¹ˆà¸¥à¸­à¸‡à¹€à¸ªà¸µà¸¢à¸šà¸à¸±à¸šà¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¸«à¸£à¸·à¸­ Smart TV à¸”à¸¹à¸™à¸°à¸„à¸£à¸±à¸š à¸–à¹‰à¸²à¸‚à¸¶à¹‰à¸™ à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸ªà¸µà¸¢à¸‡à¸£à¸–à¸„à¸£à¸±à¸šâ€ [Step 2] à¸à¸²à¸£à¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸š - â€œà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸±à¸‡à¸§à¸¥à¹€à¸¥à¸¢à¸„à¸£à¸±à¸šà¸žà¸µà¹ˆ à¸œà¸¡à¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸šà¹ƒà¸«à¹‰ 100% à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸ªà¸±à¸à¸à¸²à¹„à¸§à¹‰à¸„à¸£à¸±à¸š à¸–à¹‰à¸²à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸ˆà¸£à¸´à¸‡ à¸œà¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹ƒà¸«à¹‰à¹ƒà¸«à¸¡à¹ˆ à¸«à¸£à¸·à¸­à¸„à¸·à¸™à¹€à¸‡à¸´à¸™à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¸£à¸±à¸šâ€ [Step 3] à¸à¸²à¸£à¸„à¸·à¸™à¸ªà¸´à¸™à¸„à¹‰à¸² (Kerry Pickup) - â€œà¹€à¸”à¸µà¹‹à¸¢à¸§à¸œà¸¡à¹€à¸£à¸µà¸¢à¸à¸£à¸– Kerry à¹„à¸›à¸£à¸±à¸šà¸–à¸¶à¸‡à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™à¸žà¸µà¹ˆà¸™à¸°à¸„à¸£à¸±à¸š à¸žà¸µà¹ˆà¹à¸„à¹ˆà¹à¸žà¹‡à¸„à¸‚à¸­à¸‡à¸£à¸­à¹„à¸§à¹‰â€ - â€œà¹€à¸¡à¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸šà¸¸à¹Šà¸„à¸à¸´à¹‰à¸‡à¹à¸¥à¹‰à¸§ à¸œà¸¡à¸ˆà¸°à¸£à¸µà¸šà¸ªà¹ˆà¸‡à¸•à¸±à¸§à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸«à¹‰à¸—à¸±à¸™à¸—à¸µ à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹€à¸ªà¸µà¸¢à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸£à¸±à¸šâ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¸ˆà¸‡à¸•à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸•à¸²à¸¡à¸à¸Žà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸”à¹‰à¸²à¸™à¸šà¸™à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™`;


// ======================
//  WEBHOOK
// ======================
app.post("/webhook", middleware(lineConfig), async (req, res) => {
  try {
    const events = req.body.events;

    if (!events || events.length === 0) {
      return res.sendStatus(200);
    }

    for (let event of events) {
      if (event.type === "message" && event.message.type === "text") {

        const userMessage = event.message.text;

        // ======================
        // Call OPENAI
        // ======================
        const ai = await openai.chat.completions.create({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: aiPrompt },
            { role: "user", content: userMessage },
          ],
        });

        const reply = ai.choices[0].message.content;

        // ======================
        // HUMAN-LIKE DELAY
        // ======================
        await humanDelay();

        // ======================
        // SEND BACK TO LINE (reply)
        // ======================
        await client.replyMessage({
          replyToken: event.replyToken,
          messages: [
            {
              type: "text",
              text: reply,
            },
          ],
        });
      }
    }

    return res.sendStatus(200);

  } catch (error) {
    console.error("Webhook error:", error);
    return res.status(500).end();
  }
});

// ======================
//  START SERVER
// ======================
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`BOT STARTED on port ${PORT}`);
});
